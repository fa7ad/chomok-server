!function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=23)}([function(e,t,r){"use strict";(function(e){r.d(t,"c",function(){return m}),r.d(t,"l",function(){return g}),r.d(t,"m",function(){return w}),r.d(t,"h",function(){return j}),r.d(t,"b",function(){return h}),r.d(t,"g",function(){return v}),r.d(t,"j",function(){return x}),r.d(t,"d",function(){return q}),r.d(t,"i",function(){return k}),r.d(t,"a",function(){return _}),r.d(t,"f",function(){return P}),r.d(t,"e",function(){return z}),r.d(t,"k",function(){return S});var n=r(4),o=r(7),a=r(12),i=r(1),s=r(13),c=r.n(s),u=r(20),l=r.n(u),d=r(9);function f(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}c.a.plugin(l.a);const p=Object(n.resolve)(process.cwd()||e),b=process.env.PORT||3333,m={secret:process.env.SECRET||"14 monkeysw",port:b,db_prefix:process.env.DB_PREFIX||"ch_",prod:!0,cwd:p,client:Object(n.resolve)(p,"client","build"),url:"https://chomok.xyz"},y=e=>new c.a(Object(n.resolve)(m.cwd,"db",m.db_prefix+e)),g=y("users"),w=y("zones"),j=y("offers"),h=y("codes");async function O(e){const t=await d.a.validate({name:"Gott",phone:"01912345678",username:"prgmlord",password:"Prgml0rd",dateReg:a.DateTime.local().toFormat("yyyyLLdd"),email:"superman@admin.com",admin:!0});return t.password=await Object(o.hash)(t.password,10),e.put(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){f(e,t,r[t])})}return e}({_id:"0a0b1a1b"},t))}const v=(e,t)=>()=>new Promise((r,n)=>{e.listen(t,e=>{e?n(e):r(!0)})});async function x(e){try{const t=await e.get("0a0b1a1b");t&&console.log(`Admin(${t._id}): prgmlord:Prgml0rd`)}catch(t){const r=await O(e);r&&console.log(`Admin(${r._id}): prgmlord:Prgml0rd`)}try{await async function(e){return e.createIndex({index:{fields:["username"],ddoc:"users-username-idx"}})}(e)}catch(e){console.log("Failed to index the database")}}const q=(e,t=!1)=>{const r={message:e.isJoi?Object(i.map)(Object(i.prop)("message"),e.details):e.message||"Internal server error"},n={status:e.status||(e.isJoi?400:e.notFound?404:500),error:r};return t&&t.status(n.status).json({ok:!1,error:r}),n},k=Object(i.compose)(Object(i.map)(Object(i.prop)("doc")),Object(i.prop)("rows"));class _ extends Error{constructor(e,t){super(t),this.status=e}}const P=()=>a.DateTime.local().setZone("UTC+6").toFormat("yyyyLLdd"),z=Object(i.curry)((e,t)=>Object(i.find)(Object(i.whereEq)(e),t)),S=(Object(i.curry)((e,t)=>Object(i.filter)(Object(i.whereEq)(e),t)),e=>Buffer.from(e).toString("base64"))}).call(this,"/")},function(e,t){e.exports=require("ramda")},function(e,t){e.exports=require("joi")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("fs-extra")},function(e,t){e.exports=require("passport")},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("sharp")},function(e,t,r){"use strict";var n=r(2),o=r.n(n),a=r(0);const i=o.a.object({name:o.a.string().trim().min(3).required(),phone:o.a.string().regex(/^(\+88|0088)?0?(1[5-9])?\d{8}$/).required(),email:o.a.string().email().required(),username:o.a.string().token().lowercase().min(4).required(),password:o.a.string().min(6).max(32).required(),dateReg:o.a.string().regex(/^\d{8}$/).default(a.f,"Registration date"),admin:o.a.boolean().default(!1),business:o.a.object().keys({address:o.a.string(),name:o.a.string(),phone:o.a.string().regex(/^(\+88|0088)?0(1[5-9])?\d{8}$/)}).requiredKeys(["address","name","phone"]),type:o.a.string().valid(["admin","partner","user"]).default(e=>e.admin?"admin":e.business?"partner":"user","user type")});t.a=i},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("luxon")},function(e,t){e.exports=require("pouchdb")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("compression")},function(e,t){e.exports=require("memorystore")},function(e,t){e.exports=require("passport-local")},function(e,t){e.exports=require("pouchdb-find")},function(e,t){e.exports=require("shortid")},function(e,t){e.exports=require("multer")},function(e,t,r){"use strict";r.r(t);var n=r(4),o=r.n(n),a=r(14),i=r.n(a),s=r(15),c=r.n(s),u=r(16),l=r.n(u),d=r(3),f=r.n(d),p=r(17),b=r.n(p),m=r(18),y=r.n(m),g=r(10),w=r.n(g),j=r(11),h=r(6),O=r.n(h),v=r(19),x=r(1),q=r(7),k=r(9),_=r(0);async function P(e,t,r){try{const n=await k.a.validate(e.body),{docs:o}=await _.l.find({selector:{username:n.username}});if(o.length>0)throw new _.a(409,"Username already exists");e.body=Object(x.merge)(n,{password:await Object(q.hash)(n.password,10)}),"user"!==n.type?z(e,t,r):r()}catch(e){r(e)}}function z(e,t,r){if(e.user&&e.user.admin)r();else{r(new _.a(e.user?403:401,"Unauthorized!"))}}function S(e,t,r){if(e.user)return r();throw new _.a(401,"Unauthorized")}function E(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const D=Object(d.Router)();D.post("/register",P,async function(e,t,r){try{await _.l.post(e.body),t.json({ok:!0})}catch(e){r(e)}}),D.post("/login",O.a.authenticate("local",{}),function(e,t){t.json({ok:!0,id:e.user._id,type:e.user.type})}),D.get("/loggedIn",(e,t)=>t.json(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){E(e,t,r[t])})}return e}({ok:!!e.user},Object(x.pickAll)(["type","username"],e.user||{})))),D.get("/logout",function(e,t){e.logout(),t.json({ok:!0})});var F=D;const I=Object(d.Router)();I.get("/:type?",async(e,t,r)=>{try{const{type:n}=e.params,{rows:o}=await _.l.allDocs({include_docs:!0}),a=Object(x.reduce)((e,t)=>{const{doc:r}=t;return r.type===n?[].concat(e,Object(x.omit)(["password"],r)):e},[]);t.json({ok:!0,data:a(o)})}catch(e){r(e)}}),I.post("/:type?",P,async(e,t,r)=>{try{await _.l.post(e.body),t.json({ok:!0})}catch(e){r(e)}}),I.delete("/:id",z,async(e,t,r)=>{try{const n=await _.l.get(e.params.id);await _.l.remove(n),t.json({ok:!0})}catch(e){r(e)}});var N=I,R=r(2),B=r.n(R);var $=B.a.object().keys({name:B.a.string().required(),division:B.a.string().required()});const L=Object(x.map)(x.toLower),T=Object(d.Router)();T.get("/",async(e,t)=>{try{const e=Object(_.i)(await _.m.allDocs({include_docs:!0}));t.json({ok:!0,data:e})}catch(e){t.status(404).json({ok:!1,error:{message:"No zones found"}})}}),T.post("/",z,async(e,t,r)=>{const n=L(e.body);try{if((await _.m.find({selector:{name:n.name}})).docs.length>0)throw new _.a(409,"Zone already exists");const e=await $.validate(n);await _.m.post(e),t.json({ok:!0})}catch(e){r(e)}}),T.get("/:div",async(e,t,r)=>{const{div:n}=L(e.params);try{if(!n)throw new _.a(400,"No division given.");const e=Object(_.i)(await _.m.allDocs({include_docs:!0})),o=Object(x.filter)(Object(x.propEq)("division",n),e);t.json({ok:!0,data:o})}catch(e){r(e)}}),T.delete("/:id",z,async(e,t,r)=>{try{const n=await _.m.get(e.params.id);await _.m.remove(n),t.json({ok:!0})}catch(e){r(e)}});var U=T;var J=B.a.object({image:B.a.string().required(),zoneid:B.a.string().required(),partnerid:B.a.string().required(),date:B.a.string().regex(/^\d{8}$/).default(_.f,"Posting Date"),offers:B.a.object({perc:[B.a.object({values:B.a.array(),win:B.a.number()}),B.a.bool()],special:[B.a.object({values:B.a.array(),win:B.a.number()}),B.a.bool()],bulk:[B.a.object({values:B.a.array(),win:B.a.number()}),B.a.bool()]}),reqBy:B.a.array().default([]),useBy:B.a.array().default([])});function A(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){M(e,t,r[t])})}return e}function M(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const C=Object(d.Router)();C.get("/",S,async(e,t,r)=>{const{type:n}=e.user;try{if(!/^(partner|admin)$/.test(n))throw new _.a(403,"Not allowed");const o=Object(x.filter)(Object(x.propEq)("partnerid",e.user._id)),a=Object(_.i)(await _.h.allDocs({include_docs:!0}));if(!a)throw new _.a(404,"No offers found");const i=await Promise.all(a.map(async e=>{return A({partner:Object(x.prop)("business")(await _.l.get(e.partnerid)),zone:await _.m.get(e.zoneid)},e)}));t.json({ok:!0,data:"partner"===n?o(i):i})}catch(e){r(e)}}),C.get("/:division/:name",async(e,t,r)=>{const n=Object(x.map)(x.toLower,e.params);try{const o=Object(_.i)(await _.m.allDocs({include_docs:!0})),a=Object(_.e)(n,o);if(!a)throw new _.a(404,"No such zone exists");const i=a._id,s=Object(_.i)(await _.h.allDocs({include_docs:!0})),c=Object(_.e)({zoneid:i,date:Object(_.f)()},s);if(!c)throw new _.a(404,"There's no offer for this region, at the moment");const{business:u}=await _.l.get(c.partnerid),l=Object(x.compose)(Object(x.merge)({partner:u}),Object(x.omit)(["reqBy","useBy"]));if(e.user){const t=Object(_.e)({id:e.user._id},c.reqBy);c.code=t}const d=l(c);t.json({ok:!0,data:d})}catch(e){r(e)}}),C.post("/",z,async(e,t,r)=>{try{const n=await J.validate(e.body);await _.h.put(A({_id:n.zoneid+"_"+Object(_.k)(n.date)},n)),t.json({ok:!0})}catch(e){r(e)}}),C.delete("/:id",z,async(e,t,r)=>{try{const n=await _.h.get(e.params.id);await _.h.remove(n),t.json({ok:!0})}catch(e){r(e)}});var Z=C,G=r(21),K=r.n(G);const V=Object(d.Router)();V.get("/:offerid/:offertype",async(e,t,r)=>{try{const{offertype:n,offerid:o}=e.params,a=await _.h.get(o);if(!a)throw new _.a(404,"No such offer");if(a.date!==Object(_.f)())throw new _.a(400,"Offer expired");if(!a.offers[n])throw new _.a(404,"Invalid offer type");const i=Object(_.i)(await _.b.allDocs({include_docs:!0})),s=Object(_.e)({offerid:o,userid:e.user._id})(i),c=Object(x.uniq)([...a.reqBy,{id:e.user._id,type:n}]);await _.h.put(Object(x.merge)(a,{reqBy:c}));let u=null===s||void 0===s?void 0:s._id,l=null===s||void 0===s?void 0:s.value;if(!u){const t=a.offers[n];l=t.win,u=(await _.b.put({_id:K.a.generate(),offerid:o,userid:e.user._id,validity:a.date,offertype:n,offers:t.values,value:l})).id}t.json({ok:!0,data:{code:u,value:l,offertype:n}})}catch(e){r(e)}}),V.get("/:promoid",S,async(e,t)=>{try{const r=await _.b.get(e.params.promoid);if(!r)throw new _.a(404,"Invalid promo code");if(!e.user._id===r.userid)throw new _.a(403,"Forbidden");t.json(r.value)}catch(e){t.sendStatus(Object(_.d)(e).status)}}),V.post("/:promoid",S,async(e,t,r)=>{try{var n;if("partner"===!(null===(n=e.user)||void 0===n?void 0:n.type))throw new _.a(403,"Only partners are allowed to verify");const o=await _.b.get(e.params.promoid);if(!o)throw new _.a(404,"Invalid promo code");if(o.validity!==Object(_.f)())throw new _.a(400,"Invalid/expired promo code");{const e=await _.h.get(o.offerid),r=Object(x.uniq)([...e.useBy,o.userid]);await _.h.put(Object(x.merge)(e,{useBy:r}));const{offertype:n,validity:a}=o,i=o.offers[o.value];t.json({ok:!0,data:{offertype:n,value:i,validity:a}})}}catch(e){r(e)}});var X=V,H=r(5),Q=r.n(H),W=r(8),Y=r.n(W),ee=r(22),te=r.n(ee);const re=o.a.join(_.c.cwd,"uploads");Y.a.cache(!1);const ne=te()({dest:re,fileFilter:function(e,t,r){if(!/^image/.test(t.mimetype))return r(new Error("Invalid file type"),!1);r(null,/^image\/(jpeg|png)$/.test(t.mimetype))}}),oe=Object(d.Router)();oe.use(f.a.static(re)),oe.post("/",function(e,t,r){if(e.user&&e.user.type&&"user"!==e.user.type)return r();r(new _.a(e.user?403:401,"Unauthorized"))},ne.single("file"),async function(e,t,r){try{if(!e.file)throw new _.a(500,"Image upload failed");console.log(e.file);const n=o.a.resolve(e.file.path),a=await Q.a.readFile(n);await Y()(a).resize(1280,null,{withoutEnlargement:!0}).png({progressive:!0,compressionLevel:9}).toFile(n+".png"),await Q.a.unlink(n),t.send(`/images/${e.file.filename}.png`)}catch(e){r(e)}}),oe.post("/logo",z,ne.single("file"),async function(e,t,r){try{if(!e.file)throw new _.a(500,"Image upload failed");const n=o.a.resolve(e.file.path),a=Q.a.readFile(n),i=o.a.join(re,"logo.png");await Q.a.exists(i)&&await Q.a.unlink(i),await Y()(a).resize(100,null,{withoutEnlargement:!0}).png({progressive:!0,compressionLevel:9,adaptiveFiltering:!0}).toFile(i),await Q.a.unlink(n),t.send("/images/logo.png")}catch(e){r(e)}}),oe.post("/bg",z,ne.single("file"),async function(e,t,r){try{if(!e.file)throw new _.a(500,"Image upload failed");const n=o.a.join(re,"bg.json"),a=await Q.a.readJSON(n),i=o.a.resolve(e.file.path),s=await Q.a.readFile(i);for(await Y()(s).resize(1920,null,{withoutEnlargement:!0}).jpeg({progressive:!0,quality:85,optimiseScans:!0}).toFile(i+".jpg"),await Q.a.unlink(i),a.push({id:new Date/1e3|0,file:i+".jpg",link:`/images/${e.file.filename}.jpg`});a.length>7;){const e=a.shift();await Q.a.unlink(e.file)}await Q.a.outputJSON(n,a),t.json(a)}catch(e){r(e)}}),oe.post("/bg/:id",z,async function(e,t,r){try{const n=o.a.join(re,"bg.json"),a=await Q.a.readJSON(n),i=Object(_.e)({id:+e.params.id},a);if(!i)throw new _.a(404,"Image not found");await Q.a.copyFile(i.file,o.a.join(re,"bg.jpg")),t.json(i)}catch(e){r(e)}}),oe.get("/bg/all",z,async function(e,t,r){try{const e=o.a.join(re,"bg.json"),n=await Q.a.readJSON(e);t.json(n)}catch(e){r(e)}});var ae=oe;const ie=f()(),se=y()(w.a),ce={secret:_.c.secret,rolling:!0,resave:!1,saveUninitialized:!0,store:new se({checkPeriod:1296e5}),cookie:{maxAge:864e5}};ie.use(l()(_.c.prod?"tiny":"dev")),ie.use(b()()),ie.use(c()()),ie.use(i()()),_.c.prod&&(Object.assign(ce,{proxy:!0,cookie:{secure:!0,domain:".chomoks.com",maxAge:864e5}}),ie.set("trust proxy",["loopback","linklocal","uniquelocal"])),ie.use(w()(ce)),ie.use(Object(j.urlencoded)({extended:!0})),ie.use(Object(j.json)({extended:!0})),ie.use(O.a.initialize()),ie.use(O.a.session()),O.a.use("local",new v.Strategy(async function(e,t,r){try{const n=Object(x.path)(["docs",0],await _.l.find({selector:{username:e},use_index:"users-username-idx"}));n?await Object(q.compare)(t,n.password)?r(null,n):r(null,!1,{message:"Incorrect password"}):r(null,!1,{message:"Incorrect username"})}catch(e){r(e)}})),O.a.serializeUser(function(e,t){t(null,e._id)}),O.a.deserializeUser(_.l.get),ie.use(f.a.static(_.c.client)),ie.use("/api",F),ie.use("/api/users",z,N),ie.use("/api/zones",U),ie.use("/api/offers",Z),ie.use("/api/codes",S,X),ie.use("/images",ae);ie.use("about|admin|contact|login|partner|offer|register".split("|").map(e=>"/"+e+"*"),(e,t)=>{t.sendFile(o.a.join(_.c.client,"index.html"))}),ie.use(function(e,t,r,n){e&&Object(_.d)(e,r)}),Object(_.j)(_.l).then(Object(_.g)(ie,_.c.port)).then(e=>{console.log("NODE_ENV:","production"),console.log(`Listening on http://localhost:${_.c.port}`)}).catch(console.error)}]);
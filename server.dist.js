!function(e){var t={};function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(o,n,function(t){return e[t]}.bind(null,n));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=21)}([function(e,t,r){"use strict";(function(e){r.d(t,"c",function(){return b}),r.d(t,"l",function(){return j}),r.d(t,"m",function(){return y}),r.d(t,"h",function(){return w}),r.d(t,"b",function(){return g}),r.d(t,"g",function(){return h}),r.d(t,"j",function(){return v}),r.d(t,"d",function(){return x}),r.d(t,"i",function(){return k}),r.d(t,"a",function(){return q}),r.d(t,"f",function(){return _}),r.d(t,"e",function(){return P}),r.d(t,"k",function(){return I});var o=r(5),n=r(6),s=r(10),a=r(1),c=r(11),i=r.n(c),u=r(18),d=r.n(u),l=r(7);function f(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}i.a.plugin(d.a);const p=Object(o.resolve)(process.cwd()||e),b={port:process.env.PORT||3333,db_prefix:process.env.DB_PREFIX||"ch_",cwd:p,client:Object(o.resolve)(p,"client","build"),prod:!0},m=e=>new i.a(Object(o.resolve)(b.cwd,"db",b.db_prefix+e)),j=m("users"),y=m("zones"),w=m("offers"),g=m("codes");async function O(e){const t=await l.a.validate({name:"Gott",phone:"01912345678",username:"prgmlord",password:"Prgml0rd",dateReg:s.DateTime.local().toFormat("yyyyLLdd"),email:"superman@admin.com",admin:!0});return t.password=await Object(n.hash)(t.password,10),e.put(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},o=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),o.forEach(function(t){f(e,t,r[t])})}return e}({_id:"0a0b1a1b"},t))}const h=(e,t)=>()=>new Promise((r,o)=>{e.listen(t,e=>{e?o(e):r(!0)})});async function v(e){try{const t=await e.get("0a0b1a1b");t&&console.log(`Admin(${t._id}): prgmlord:Prgml0rd`)}catch(t){const r=await O(e);r&&console.log(`Admin(${r._id}): prgmlord:Prgml0rd`)}try{await async function(e){return e.createIndex({index:{fields:["username"],ddoc:"users-username-idx"}})}(e)}catch(e){console.log("Failed to index the database")}}function x(e){const t={message:e.isJoi?Object(a.map)(Object(a.prop)("message"),e.details):e.message||"Internal server error"};return{status:e.status||(e.isJoi?400:500),error:t}}const k=Object(a.compose)(Object(a.map)(Object(a.prop)("doc")),Object(a.prop)("rows"));class q extends Error{constructor(e,t){super(t),this.status=e}}const _=()=>s.DateTime.local().toFormat("yyyyLLdd"),P=Object(a.curry)((e,t)=>Object(a.find)(Object(a.whereEq)(e),t)),I=(Object(a.curry)((e,t)=>Object(a.filter)(Object(a.whereEq)(e),t)),e=>Buffer.from(e).toString("base64"))}).call(this,"/")},function(e,t){e.exports=require("ramda")},function(e,t){e.exports=require("joi")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("passport")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("bcrypt")},function(e,t,r){"use strict";var o=r(2),n=r.n(o),s=r(0);const a=n.a.object({name:n.a.string().trim().min(3).required(),phone:n.a.string().regex(/^(\+88|0088)?0?(1[5-9])?\d{8}$/).required(),email:n.a.string().email().required(),username:n.a.string().token().lowercase().min(4).required(),password:n.a.string().min(6).max(32).required(),dateReg:n.a.string().regex(/^\d{8}$/).default(s.f,"Registration date"),admin:n.a.boolean().default(!1),business:n.a.object().keys({address:n.a.string(),name:n.a.string(),phone:n.a.string().regex(/^(\+88|0088)?0(1[5-9])?\d{8}$/)}).requiredKeys(["address","name","phone"]),type:n.a.string().valid(["admin","partner","user"]).default(e=>e.admin?"admin":e.business?"partner":"user","user type")});t.a=a},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("luxon")},function(e,t){e.exports=require("pouchdb")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("compression")},function(e,t){e.exports=require("memorystore")},function(e,t){e.exports=require("passport-local")},function(e,t){e.exports=require("pouchdb-find")},function(e,t){e.exports=require("shortid")},function(e,t){e.exports=require("qrcode")},function(e,t,r){"use strict";r.r(t);var o=r(5),n=r.n(o),s=r(12),a=r.n(s),c=r(13),i=r.n(c),u=r(14),d=r.n(u),l=r(3),f=r.n(l),p=r(15),b=r.n(p),m=r(16),j=r.n(m),y=r(8),w=r.n(y),g=r(9),O=r(4),h=r.n(O),v=r(17),x=r(1),k=r(6),q=r(7),_=r(0);async function P(e,t,r){try{const o=await q.a.validate(e.body),{docs:n}=await _.l.find({selector:{username:o.username}});if(n.length>0)throw Object(_.a)(409,"Username already exists");e.body=Object(x.merge)(o,{password:await Object(k.hash)(o.password,10)}),"user"!==o.type?I(e,t,r):r()}catch(e){const{status:r,error:o}=Object(_.d)(e);t.status(r).json({ok:!1,error:o})}}function I(e,t,r){e.user&&e.user.admin?r():t.status(e.user?403:401).json({ok:!1,error:{message:"Only admin can access this data"}})}function D(e,t,r){if(e.user)return r();t.status(401).json({ok:!1,error:{message:"Please login to access this data"}})}function z(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const S=Object(l.Router)();S.post("/register",P,async function(e,t){try{if(!await _.l.post(e.body))throw Object(_.a)(500,"Internal server error");t.json({ok:!0})}catch(e){const{status:r,error:o}=Object(_.d)(e);t.status(r).json({ok:!1,error:o})}}),S.post("/login",h.a.authenticate("local",{}),function(e,t){t.json({ok:!0,id:e.user._id,type:e.user.type})}),S.get("/loggedIn",(e,t)=>t.json(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},o=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),o.forEach(function(t){z(e,t,r[t])})}return e}({ok:!!e.user},Object(x.pickAll)(["type","username"],e.user||{})))),S.get("/logout",function(e,t){e.logout(),t.json({ok:!0})});var E=S;const R=Object(l.Router)();R.get("/:type?",async(e,t)=>{try{const{type:r}=e.params,{rows:o}=await _.l.allDocs({include_docs:!0}),n=Object(x.reduce)((e,t)=>{const{doc:o}=t;return o.type===r?[].concat(e,Object(x.omit)(["password"],o)):e},[]);t.json({ok:!0,data:n(o)})}catch(e){t.status(e.notFound?404:500).json({ok:!1,error:{message:e.message||"No users found"}})}}),R.post("/:type?",P,async(e,t)=>{try{if(!await _.l.post(e.body))throw Object(_.a)(500,"Internal server error");t.json({ok:!0})}catch(e){const{status:r,error:o}=Object(_.d)(e);t.status(r).json({ok:!1,error:o})}}),R.delete("/:id",I,async(e,t)=>{try{const r=await _.l.get(e.params.id);if(!await _.l.remove(r))throw new _.a(500,"Internal server error");t.json({ok:!0})}catch(e){const{error:r,status:o}=Object(_.d)(e);t.status(o).json({ok:!1,error:r})}});var B=R,N=r(2),L=r.n(N);var $=L.a.object().keys({name:L.a.string().required(),division:L.a.string().required()});const F=Object(x.map)(x.toLower),T=Object(l.Router)();T.get("/",async(e,t)=>{try{const e=Object(_.i)(await _.m.allDocs({include_docs:!0}));t.json({ok:!0,data:e})}catch(e){t.status(404).json({ok:!1,error:{message:"No zones found"}})}}),T.post("/",I,async(e,t)=>{const r=F(e.body);try{if((await _.m.find({selector:{name:r.name}})).docs.length>0)throw new _.a(409,"Zone already exists");const e=await $.validate(r);if(!await _.m.post(e))throw new _.a(500,"Internal server error");t.json({ok:!0})}catch(e){const{status:r,error:o}=Object(_.d)(e);t.status(r).json({ok:!1,error:o})}}),T.get("/:div",async(e,t)=>{const{div:r}=F(e.params);try{if(!r)throw new _.a(400,"No division given.");const e=Object(_.i)(await _.m.allDocs({include_docs:!0})),o=Object(x.filter)(Object(x.propEq)("division",r),e);t.json({ok:!0,data:o})}catch(e){const{status:r,error:o}=Object(_.d)(e);t.status(r||404).json({ok:!1,error:o})}}),T.delete("/:id",I,async(e,t)=>{try{const r=await _.m.get(e.params.id);if(!await _.m.remove(r))throw new _.a(500,"Internal server error");t.json({ok:!0})}catch(e){const{error:r,status:o}=Object(_.d)(e);t.status(o).json({ok:!1,error:r})}});var A=T;var U=L.a.object().keys({image:L.a.string().required(),zoneid:L.a.string().required(),partnerid:L.a.string().required(),date:L.a.string().regex(/^\d{8}$/).default(_.f,"Posting Date"),percentage:L.a.number().required().min(0).max(100),reqBy:L.a.array().default([]),useBy:L.a.array().default([])});function M(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},o=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),o.forEach(function(t){J(e,t,r[t])})}return e}function J(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const G=Object(l.Router)();G.get("/",D,async(e,t)=>{const{type:r}=e.user;try{if(!/^(partner|admin)$/.test(r))throw new _.a(403,"Not allowed");const o=Object(x.filter)(Object(x.propEq)("partnerid",e.user._id)),n=Object(_.i)(await _.h.allDocs({include_docs:!0}));if(!n)throw new _.a(404,"No offers found");const s=await Promise.all(n.map(async e=>{return M({partner:Object(x.prop)("business")(await _.l.get(e.partnerid)),zone:await _.m.get(e.zoneid)},e)}));t.json({ok:!0,data:"partner"===r?o(s):s})}catch(e){const{status:r,error:o}=Object(_.d)(e);t.status(r).json({ok:!1,error:o})}}),G.get("/:division/:name",async(e,t)=>{const r=Object(x.map)(x.toLower,e.params);try{const e=Object(_.i)(await _.m.allDocs({include_docs:!0})),o=Object(_.e)(r,e);if(!o)throw new _.a(404,"No such zone exists");const n=o._id,s=Object(_.i)(await _.h.allDocs({include_docs:!0})),a=Object(_.e)({zoneid:n,date:Object(_.f)()},s);if(!a)throw new _.a(404,"There's no offer for this region, at the moment");const c=Object(x.prop)("business")(await _.l.get(a.partnerid));if(!c)throw new _.a(500,"Not a valid offer");const i=Object(x.compose)(Object(x.merge)({partner:c}),Object(x.omit)(["reqBy","useBy"]));t.json({ok:!0,data:i(a)})}catch(e){const{status:r,error:o}=Object(_.d)(e);t.status(r).json({ok:!1,error:o})}}),G.post("/",I,async(e,t)=>{try{const r=await U.validate(e.body);if(!await _.h.put(M({_id:r.zoneid+"_"+Object(_.k)(r.date)},r)))throw new _.a(500,"Internal server error");t.json({ok:!0})}catch(e){const{error:r,status:o}=Object(_.d)(e);t.status(o).json({ok:!1,error:r})}}),G.delete("/:id",I,async(e,t)=>{try{const r=await _.h.get(e.params.id);if(!await _.h.remove(r))throw new _.a(500,"Internal server error");t.json({ok:!0})}catch(e){const{error:r,status:o}=Object(_.d)(e);t.status(o).json({ok:!1,error:r})}});var K=G,V=r(19),X=r.n(V),Z=r(20),C=r.n(Z);const H=Object(l.Router)();H.get("/:offerid",async(e,t)=>{try{const r=await _.h.get(e.params.offerid);if(r.date!==Object(_.f)())throw new _.a(400,"Offer not valid for the date");if(!await _.h.put(Object(x.merge)(r,{reqBy:Object(x.uniq)([].concat(r.reqBy,e.user._id))})))throw new _.a(500,"Internal server error");let o;const{docs:n}=await _.b.find({selector:{offerid:e.params.offerid,userid:e.user._id}});if(n)o=n[0]._id;else{if(o=X.a.generate(),!await _.b.put({_id:o,offerid:e.params.offerid,userid:e.user._id,validity:r.date,value:r.percentage}))throw new _.a(500,"Internal server error")}t.json({ok:!0,data:{code:o,qr:await C.a.toDataURL("chomok://"+o)}})}catch(e){const{status:r,error:o}=Object(_.d)(e);t.status(r).json({ok:!1,error:o})}}),H.post("/:promoid",async(e,t)=>{try{if("partner"===!e.user.type)throw Object(_.a)(401,"Only partners are allowed to verify");const r=await _.b.get(e.params.promoid);if(!r)throw new _.a(404,"Invalid promo code");const o=e.user._id===r.userid,n=Object(_.f)()===r.validity;if(!o||!n)throw new _.a(400,"Invalid/expired promo code");{const o=await _.h.get(r.offerid);if(!await _.h.put(Object(x.merge)(o,{useBy:Object(x.uniq)([].concat(o.useBy,e.user._id))})))throw new _.a(500,"Internal server error");t.json({ok:!0,data:{percentage:r.value}})}}catch(e){const{status:r,error:o}=Object(_.d)(e);t.status(r).json({ok:!1,error:o})}});var Q=H;const W=f()(),Y={secret:"monkey 13",rolling:!0,resave:!1,saveUninitialized:!0,store:new(j()(w.a))({checkPeriod:72e5}),cookie:{maxAge:6e5}};W.use(d()(_.c.prod?"tiny":"dev")),W.use(b()()),W.use(i()()),W.use(a()()),_.c.prod&&(Object.assign(Y,{proxy:!0,cookie:{secure:!0,domain:".chomok.xyz",maxAge:6e5}}),W.set("trust proxy",["loopback","linklocal","uniquelocal"])),W.use(w()(Y)),W.use(Object(g.urlencoded)({limit:"5mb",extended:!0})),W.use(Object(g.json)({limit:"5mb",extended:!0})),W.use(h.a.initialize()),W.use(h.a.session()),h.a.use("local",new v.Strategy(async function(e,t,r){try{const o=Object(x.path)(["docs",0],await _.l.find({selector:{username:e},use_index:"users-username-idx"}));o?await Object(k.compare)(t,o.password)?r(null,o):r(null,!1,{message:"Incorrect password"}):r(null,!1,{message:"Incorrect username"})}catch(e){r(e)}})),h.a.serializeUser(function(e,t){t(null,e._id)}),h.a.deserializeUser(_.l.get),W.use(f.a.static(_.c.client)),W.use("/api",E),W.use("/api/users",I,B),W.use("/api/zones",A),W.use("/api/offers",K),W.use("/api/codes",D,Q),W.use("*",(e,t)=>{t.sendFile(n.a.join(_.c.client,"index.html"))}),Object(_.j)(_.l).then(Object(_.g)(W,_.c.port)).then(e=>{console.log("NODE_ENV:","production"),console.log(`Listening on http://localhost:${_.c.port}`)}).catch(console.error)}]);